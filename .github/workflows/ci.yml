
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Scripts and Configuration
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck jq
    
    - name: Validate shell scripts
      run: |
        echo "üîç Validating shell scripts..."
        find scripts/ -name "*.sh" -exec shellcheck {} \;
        echo "‚úÖ Shell scripts validation completed"
    
    - name: Validate JSON configuration files
      run: |
        echo "üîç Validating JSON files..."
        find configs/ -name "*.json" -exec jq empty {} \;
        echo "‚úÖ JSON files validation completed"
    
    - name: Validate Docker configuration
      run: |
        echo "üîç Validating Docker files..."
        docker --version
        docker compose config
        echo "‚úÖ Docker configuration validation completed"
    
    - name: Test Docker build
      run: |
        echo "üîç Testing Docker build..."
        docker compose build
        echo "‚úÖ Docker build test completed"
    
    - name: Run basic functionality tests
      run: |
        echo "üîç Running basic functionality tests..."
        docker compose run --rm provisioner bash -c "
          echo 'Testing script permissions...'
          ls -la scripts/
          echo 'Testing configuration access...'
          ls -la configs/
          echo 'Testing basic script execution...'
          bash scripts/collect-local-info.sh --help || echo 'Help not available'
        "
        echo "‚úÖ Basic functionality tests completed"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  documentation:
    runs-on: ubuntu-latest
    name: Documentation Check
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Check documentation completeness
      run: |
        echo "üîç Checking documentation..."
        
        # Check if required documentation files exist
        required_files=(
          "README.md"
          "TESTING_GUIDE.md"
          "USE_CASES.md"
          "DEVELOPMENT.md"
          "TROUBLESHOOTING.md"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file is missing"
            exit 1
          fi
        done
        
        echo "‚úÖ All required documentation files are present"
    
    - name: Validate markdown syntax
      # uses: DavidAnson/markdownlint-action@v1
      uses: davidanson/markdownlint-cli2-action@v13
      with:
        files: '**/*.md'
        config: '.markdownlint.json'
        ignore: 'node_modules'
